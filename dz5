# Домашнее задание 5
Тема: построение регрессионных моделей и анализ выживаемости.
  
```{r}
#импорт
library(ggplot2)
library(tidyverse)
library(car)
library(survival)
library(ggsurvfit)
library(survminer)
```

```{r}
#загружаем датасет
cancer <- read.csv("dz3/wisconsin_breast_cancer.csv")
head(cancer)
str(cancer)
```
### Задание 1 
Создайте регрессионную модель, которая бы описывала связь среднего радиуса опухоли и средней площади (а), среднего периметра (б), средней симметричности (в). 
Постройте графики, на которых отразите регрессионную прямую, и прокомментируйте свои находки.

```{r}
#проверяем пропуски
colSums(is.na(cancer[c("radius_mean", "area_mean", "perimeter_mean", "symmetry_mean")]))
#их нет
```
Нам нужна линейная регрессия. Гиптоезы:
*Н0 - факторы не имеют статистически значимой линейной зависимости*
*Н1 - факторы имеют статистически значимую линейную зависимость*

```{r}
#построение модели линейной регрессии 
fit1 <- lm(radius_mean ~ area_mean + perimeter_mean + symmetry_mean, data = cancer) 
summary(fit1)
```
Результаты анализа модели представляют собой следующее:

- Распределение остатков характеризуется минимальным, максимальным значением, медианой и интерквартильным размахом.
- Коэффициенты предикторов показывают, как изменяется радиус опухоли при увеличении значений предикторов на единицу. Например, увеличение средней площади и периметра приводит к увеличению среднего радиуса, в то время как увеличение средней симметричности приводит к его уменьшению.
- Значение коэффициента пересечения показывает значение радиуса опухоли при нулевых значениях факторов.
- Показатель p-value статистически значим во всех случаях, что свидетельствует о статистической значимости линейной зависимости между средним радиусом опухоли и другими факторами.
- Общая статистика модели и ее p-value указывают на статистическую значимость модели.
- Остаточная стандартная ошибка модели и скорректированный коэффициент детерминации указывают на то, насколько хорошо модель предсказывает изменчивость среднего радиуса опухоли. В данном случае модель предсказывает около 99.7% изменчивости, что может свидетельствовать о качестве модели или о ее переобученности.

Необходимо также удостовериться, что выполняются условия линейной регрессионной модели, включая линейность зависимости факторов.

```{r}
#оценка линейности зависимости зависимой переменной 
cancer %>%
    ggplot(aes(x = area_mean, y = radius_mean)) +
    geom_point() +
    labs(title = "Зависимость среднего радиуса и среней площади опухоли",
      x = "Средняя площадь опухоли",
      y = "Средний радиус опухоли") + 
    geom_smooth(method = "lm")
    `geom_smooth()` using formula = 'y ~ x'
```

```{r}
#оценка линейности зависимости зависимой переменной
cancer %>%
    ggplot(aes(x = perimeter_mean, y = radius_mean)) +
    geom_point() +
    labs(title = "Зависимость среднего радиуса и сренего периметра опухоли",
      x = "Среднего периметра опухоли",
      y = "Средний радиус опухоли") +
    geom_smooth(method = "lm")
    `geom_smooth()` using formula = 'y ~ x'
```

```{r}
#оценка линейности зависимости зависимой переменной
cancer %>%
    ggplot(aes(x = symmetry_mean, y = radius_mean)) +
    geom_point() +
    labs(title = "Зависимость среднего радиуса и среней симметричности опухоли",
      x = "Средняя симметричности опухоли",
      y = "Средний радиус опухоли") +
    geom_smooth(method = "lm")
    `geom_smooth()` using formula = 'y ~ x'
```
Все факторы имеют линейную зависимость с зависимой переменной.
```{r}
# Визуальная оценка нормальности распределения остатков
qqPlot(residuals(fit1))
```

```{r}
#оценивем нормальность распределения остатков с помощью теста Шапиро-Уилка
shapiro.test(residuals(fit1))
```
На большей части графика мы наблюдаем, что остатки (точки) в основном не сильно отклоняются и остаются в пределах заданных интервалов. Однако на левой части графика эти отклонения значительно выражены и выходят за установленные интервалы.

Тест Шапиро-Уилка подтверждает, что остатки не имеют нормальное распределение, так как значение `p-value = 1.072e-11`, что меньше стандартного уровня значимости 0.05. Следовательно, мы не можем принять гипотезу о нормальном распределении остатков и отвергаем ее.

Что касается гомоскедастичности остатков, можно сказать, что это свойство означает однородность дисперсии остатков по всем уровням независимой переменной. Если остатки не проявляют гомоскедастичность, то это может указывать на наличие систематических различий в изменчивости остатков по разным уровням независимой переменной.

```{r}
#оценка распределения остатков 
plot(fit1, which = 1)
```
Для проверки отсутствия мультиколлинеарности, то есть отсутствия значительной корреляции между независимыми переменными, мы можем построить графики распределения независимых переменных попарно друг с другом. Это позволит визуально оценить наличие каких-либо корреляций между переменными.

Давайте построим эти графики для проведения более детального анализа и выявления возможной мультиколлинеарности. Если на графиках будет видна какая-то систематическая зависимость между независимыми переменными, это может свидетельствовать о наличии мультиколлинеарности, что может повлиять на результаты моделирования.

```{r}
cancer %>%
    ggplot(aes(x = area_mean, y = perimeter_mean)) +
    geom_point() +
    labs(title = "Зависимость средней площади и сренего периметра опухоли",
      x = "Средняя площадь опухоли",
      y = "Средний периметр опухоли")
```

```{r}
cancer %>%
    ggplot(aes(x = area_mean, y = symmetry_mean)) +
    geom_point() +
    labs(title = "Зависимость средней площади и сренеей симметричности опухоли",
      x = "Средняя площадь опухоли",
      y = "Средняя симметричность опухоли") 
```

```{r}
cancer %>%
    ggplot(aes(x = perimeter_mean, y = symmetry_mean)) +
    geom_point() +
    labs(title = "Зависимость среднего периметра и сренеей симметричности опухоли",
      x = "Средней симметричности опухоли",
      y = "Средний периметр опухоли")
```
По графику видно, что существует сильная линейная зависимость между признаками "средняя площадь" и "средний периметр". Это указывает на наличие мультиколлинеарности между этими признаками, что может негативно сказаться на результате моделирования. Для построения эффективной модели рекомендуется исключить один из этих признаков, например, "средний периметр опухоли".

Также, учитывая наличие гетероскедастичности, можно рассмотреть варианты преобразования или переопределения зависимой переменной, а также использовать взвешенную регрессию для учета этого явления.

Еще одно важное требование для линейной регрессии соблюдается в нашем датасете - наблюдения являются независимыми, так как представлены отдельными, несвязанными друг с другом наблюдениями.

### Задание 2 

Пусть колонка с диагнозом принимает следующие значения: злокачественная опухоль — 1, а доброкачественная — 0. Постройте модель, которая бы прогнозировала вероятность возникновения злокачественной опухоли от среднего радиуса (а), средней площади (б), средней текстуры (в).
Постройте графики. Создайте модель, которая бы прогнозировала вероятность возникновения злокачественной опухоли от всех трех перечисленных факторов.

```{r}
#преобразование столбца с диагнозом
cancer$diagnosis <- ifelse(cancer$diagnosis == 'M', 1, 0)

#перепроверяем
head(select(cancer, diagnosis),10)
```
*Н0 - факторы не имеют статистически значимой зависимости*
*Н1 - факторы имеют статистически значимую зависимость*

Берем логистическую регрессию из-за категориальных независимых.
```{r}
#модель логистической регрессии
gfit1 <-
  glm(diagnosis ~ radius_mean + area_mean + texture_mean, data = cancer, family = "binomial")
summary(gfit1)
```

Для более понятной интерпретации результатов модели следует сделать следующее преобразование коэффициентов:

- Интерсепт представляет собой значение логарифма отношения шансов диагностирования злокачественной опухоли (кодированной как `1`) к доброкачественной опухоли (кодированной как `0`), когда все предикторы равны 0. Отрицательное значение указывает на то, что при нулевых значениях предикторов вероятность диагностирования злокачественной опухоли выше, чем доброкачественной. Увеличение среднего радиуса уменьшает шансы на диагностирование доброкачественной опухоли и увеличивает вероятность диагностирования злокачественной опухоли. Средняя площадь и текстура опухоли также влияют на вероятность диагностирования типа опухоли.

- `p-value` для среднего радиуса и средней площади оказалось статистически незначимым (`p-value > alpha`), что означает, что связь, отраженная в коэффициентах этих признаков, статистически не значима и не влияет на вероятность диагностирования типа опухоли. Для текстуры опухоли `p-value < alpha`, что указывает на статистическую значимость взаимосвязи между текстурой опухоли и типом опухоли.

- Остаточное отклонение (Deviance Residuals) составляет 288.81 для 565 степеней свободы, а нулевое отклонение (Null Deviance) равно 751.44 для 565 степеней свободы.

```{r}
exp(coefficients(gfit1))
```

Таким образом, учитывая статистическую значимость влияния всех предикторов, мы можем сделать вывод, что при диагностировании доброкачественной опухоли в сравнении с злокачественной средняя текстура опухоли будет больше в 1.23 раза, и эта разница является статистически значимой. Влияние других факторов на тип опухоли является статистически незначимым.

Логистическая регрессия имеет свои требования и предположения, такие как:

- Мультиколлинеарность между факторами
- Линейная связь между факторами и логитом зависимой переменной
- Отсутствие экстремальных выбросов

В данном случае проверка этих предположений не проводилась, поскольку это не было указано в задании.

```{r}
#визуализация кривой логистической регрессии 
cancer %>%
    ggplot(aes(x = radius_mean, y = diagnosis)) +
    geom_point() +
    labs(title = "Зависимость типа опухоли и сренего радиуса опухоли",
      x = "Средний радиус опухоли",
      y = "Тип опухоли") +
    geom_smooth(method = "glm", 
                method.args = list(family = "binomial")) +
  theme_bw()
```

```{r}
#визуализация кривой логистической регрессии 
cancer %>%
    ggplot(aes(x = area_mean, y = diagnosis)) +
    geom_point() +
    labs(title = "Зависимость типа опухоли и среней площади опухоли",
      x = "Средняя площадь опухоли",
      y = "Тип опухоли") +
    geom_smooth(method = "glm", 
                method.args = list(family = "binomial")) +
  theme_bw()
```

```{r}
#визуализация кривой логистической регрессии 
cancer %>%
    ggplot(aes(x = texture_mean, y = diagnosis)) +
    geom_point() +
    labs(title = "Зависимость типа опухоли и сренего значения текстуры опухоли",
      x = "Средняя текстура опухоли",
      y = "Тип опухоли") +
    geom_smooth(method = "glm", 
                method.args = list(family = "binomial")) +
  theme_bw()
```

Логистическая регрессионная модель.

```{r}
gfit2 <-
  glm(diagnosis ~ radius_mean * area_mean * texture_mean,
      data = cancer,
      family = "binomial")

summary(gfit2)
```

Исходя из результатов логистической регрессии с участием всех трех факторов, можно отметить, что все взаимодействия между ними статистически не значимы, так как значения `p-value` оказались больше уровня значимости `alpha`.

### Задание 3 

Для выполнения этого задания вам понадобится датасет lung, который встроен в пакет survival. Установите этот пакет и загрузите датасет.

```{r}
lung <- survival::lung
head(lung)
```

Создайте переменную event, в которой отразите наличие или отсутствие (1 или 0) интересующего события — смерти пациента.

```{r}
lung$event <- ifelse(lung$status == 2,1,0)
head(lung)
```

```{r}
#делаем выборку пациентов, которые достигли целевого события 
lung_2 <- filter(lung,lung$event == 1)
head(lung_2)
```

```{r}
#график кривых выживаемости от пола
surv_fit <- survfit(Surv(time, status) ~ sex, data = lung_2)

ggsurvplot(surv_fit, conf.int = TRUE, surv.median.line = 'hv', risk.table = TRUE)
```
На графике кривых выживаемости ось x представляет время, а ось y - долю выживших пациентов, отражая изменения в выживаемости во времени. Обнаружено, что доверительные интервалы для двух групп пересекаются, а линии графика также пересекаются. Это может указывать на отсутствие статистически значимых различий в выживаемости между группами по половому признаку. Уровень значимости установлен на alpha = 0.05.

Гипотезы:
H0 - Разницы в выживаемости между двумя группами нет.
H1 - Существует разница в выживаемости между двумя группами, разделенными по полу.

```{r}
#лог-ранг тест
survdiff(Surv(time, status) ~ sex, data = lung_2)
```
При значении `P-value = 0.1`, что означает, что `p-value > alpha`, мы не можем отвергнуть нулевую гипотезу. Следовательно, мы принимаем нулевую гипотезу, что нет статистически значимой разницы в выживаемости между двумя группами, разделенными по полу.

```{r}
#график кумулятивной функции рисков по полу
ggsurvplot(surv_fit, fun = "cumhaz", conf.int = TRUE, risk.table = TRUE)
```

На графике кумулятивной функции рисков ось x отображает время, а ось y - риск целевых событий, показывая, как риск меняется во времени.

Обнаружено, что доверительные интервалы для двух групп пересекаются, и линии графика также пересекаются. Это может указывать на отсутствие статистически значимых различий в уровне риска между группами по половому признаку.

Затем, с использованием функции coxph() была построена регрессия Кокса для оценки влияния пола на выживаемость. Результаты показали... (добавьте ваши выводы о полученных результатах).

```{r}
#регрессия Кокса
cox <- coxph(Surv(time, status) ~ sex, data = lung_2)
summary(cox)
```

В результате анализа получено значение `p-value = 0.136`, что означает, что различие между группами по половому признаку статистически незначимо, так как `p-value > alpha`.

Кроме того, мы можем оценить разницу в риске между двумя группами по полу с помощью коэффициента (coef) и экспоненты коэффициента (exp(coef)). В данном случае относительный уровень риска (exp(coef)) составляет 0.7779.

```{r}
# Выполнение преобразования exp(coef) и exp(-coef)
(1 - 0.7779) * 100 
(1 - 1.285) * 100 
```
Хотя риск смерти в группе женщин может быть на 22.21% ниже, чем у мужчин, и риск смерти в группе мужчин может быть на 28.5% выше, результаты регрессии Кокса показали, что эти различия не являются статистически значимыми.

Тесты Likelihood ratio и Wald также подтвердили отсутствие статистически значимых различий в результатах.

Важно отметить, что анализ был проведен только на пациентах, достигших целевого события (смерти), что не является оптимальным подходом для оценки выживаемости и риска. При учете цензурирования и включении всех пациентов из датасета, вероятно, были бы обнаружены статистически значимые различия между группами по выживаемости и риску.
